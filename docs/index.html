<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UDI Label Generator</title>

  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/* üî• HARD-CODED TOKEN (TEST ONLY) */
const TOKEN = "PASTE_YOUR_TOKEN_HERE";

const UDILabelGenerator = () => {
  const [products, setProducts] = useState([]);
  const [selectedProduct, setSelectedProduct] = useState("");
  const [mfgDate, setMfgDate] = useState("");
  const [serialNumber, setSerialNumber] = useState("");
  const [labelCount, setLabelCount] = useState("1");
  const [isLoading, setIsLoading] = useState(false);
  const [message, setMessage] = useState(null);

  /* ----------------------------------
     LOAD PRODUCT DATABASE
  ----------------------------------*/
  useEffect(() => {
    (async () => {
      try {
        const res = await fetch(
          "https://raw.githubusercontent.com/KleinMed-AG/gtin/main/product_db.json"
        );
        const data = await res.json();
        setProducts(data.products);
      } catch (err) {
        setMessage({ type: "error", text: err.message });
      }
    })();
  }, []);

  /* ----------------------------------
     AUTO SERIAL
  ----------------------------------*/
  useEffect(() => {
    if (!selectedProduct) return;
    const p = products.find(x => x.id === selectedProduct);
    if (p) setSerialNumber(String(p.lastSerial + 1));
  }, [selectedProduct, products]);

  /* ----------------------------------
     SUBMIT
  ----------------------------------*/
  const handleSubmit = async () => {
    const product = products.find(p => p.id === selectedProduct);
    if (!product) return;

    setIsLoading(true);
    setMessage(null);

    try {
      const response = await fetch(
        "https://api.github.com/repos/KleinMed-AG/gtin/actions/workflows/generate-labels.yml/dispatches",
        {
          method: "POST",
          headers: {
            "Accept": "application/vnd.github+json",
            "Authorization": `Bearer ${TOKEN}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            ref: "main",
            inputs: {
              product: product.name,
              gtin: product.gtin,
              mfg_date: mfgDate,
              serial_start: String(serialNumber),
              count: String(labelCount)
            }
          })
        }
      );

      if (!response.ok) {
        throw new Error("GitHub Workflow konnte nicht gestartet werden");
      }

      setMessage({
        type: "success",
        text: `Workflow gestartet f√ºr ${product.name}`
      });

    } catch (err) {
      setMessage({ type: "error", text: err.message });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-100 flex items-center justify-center">
      <div className="bg-white p-6 rounded-xl shadow w-full max-w-md">
        <h1 className="text-2xl font-bold mb-4">UDI Label Generator</h1>

        <select
          className="w-full mb-3 p-2 border rounded"
          value={selectedProduct}
          onChange={e => setSelectedProduct(e.target.value)}
        >
          <option value="">Produkt w√§hlen</option>
          {products.map(p => (
            <option key={p.id} value={p.id}>
              {p.name}
            </option>
          ))}
        </select>

        <input
          className="w-full mb-3 p-2 border rounded"
          placeholder="Herstellungsdatum JJMMTT"
          value={mfgDate}
          onChange={e => setMfgDate(e.target.value.replace(/\D/g,"").slice(0,6))}
        />

        <input
          className="w-full mb-3 p-2 border rounded"
          type="number"
          placeholder="Start-Seriennummer"
          value={serialNumber}
          onChange={e => setSerialNumber(e.target.value)}
        />

        <input
          className="w-full mb-4 p-2 border rounded"
          type="number"
          placeholder="Anzahl Labels"
          value={labelCount}
          onChange={e => setLabelCount(e.target.value)}
        />

        <button
          onClick={handleSubmit}
          disabled={isLoading}
          className="w-full bg-blue-600 text-white py-2 rounded"
        >
          {isLoading ? "Starte‚Ä¶" : "UDI Job starten"}
        </button>

        {message && (
          <p className={`mt-4 ${
            message.type === "error" ? "text-red-600" : "text-green-600"
          }`}>
            {message.text}
          </p>
        )}
      </div>
    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<UDILabelGenerator />);
</script>
</body>
</html>
