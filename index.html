<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UDI Label Generator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const UDILabelGenerator = () => {
          const [products, setProducts] = useState([]);
          const [selectedProduct, setSelectedProduct] = useState('');
          const [mfgDate, setMfgDate] = useState('');
          const [serialNumber, setSerialNumber] = useState('');
          const [labelCount, setLabelCount] = useState('1');
          const [isLoading, setIsLoading] = useState(false);
          const [message, setMessage] = useState(null);
          const [errors, setErrors] = useState({});
          const [workflowStatus, setWorkflowStatus] = useState(null);
          const [downloadUrl, setDownloadUrl] = useState(null);

          const API_URL = 'https://gtin-kohl.vercel.app/api/trigger';

          useEffect(() => {
            loadProductDatabase();
          }, []);

          const loadProductDatabase = async () => {
            try {
              // Try GitHub API first
              let data;
              try {
                const apiResponse = await fetch('https://api.github.com/repos/KleinMed-AG/gtin/contents/product_db.json', {
                  headers: {
                    'Accept': 'application/vnd.github.v3+json'
                  }
                });
      
                if (apiResponse.ok) {
                  const fileData = await apiResponse.json();
                  const content = atob(fileData.content);
                  data = JSON.parse(content);
                } else {
                  throw new Error('API failed, trying raw URL');
                }
              } catch (apiError) {
                // Fallback to raw URL
                console.log('API failed, using raw URL:', apiError);
                const timestamp = new Date().getTime();
                const rawResponse = await fetch(`https://raw.githubusercontent.com/KleinMed-AG/gtin/main/product_db.json?t=${timestamp}`, {
                  cache: 'no-store'
                });
      
                if (!rawResponse.ok) {
                  throw new Error(`HTTP error! status: ${rawResponse.status}`);
                }
      
                data = await rawResponse.json();
              }
    
              if (data && data.products && Array.isArray(data.products)) {
                setProducts(data.products);
                console.log('Products loaded:', data.products.length);
              } else {
                throw new Error('Invalid data format');
              }
            } catch (error) {
              console.error('Full error:', error);
              setMessage({
                type: 'error',
                text: 'Fehler beim Laden der Produktdatenbank: ' + error.message
              });
            }
          };

          const handleRefresh = async () => {
            await loadProductDatabase();
            if (selectedProduct) {
              const product = products.find(p => p.id === selectedProduct);
              if (product) {
                setSerialNumber(String(product.lastSerial + 1));
              }
            }
          };

          useEffect(() => {
            if (selectedProduct) {
              const product = products.find(p => p.id === selectedProduct);
              if (product) {
                setSerialNumber(String(product.lastSerial + 1));
              }
            }
          }, [selectedProduct, products]);

          const checkWorkflowStatus = async (runId, repo) => {
            try {
              const response = await fetch(
                `https://api.github.com/repos/${repo}/actions/runs/${runId}`,
                {
                  headers: {
                    'Accept': 'application/vnd.github.v3+json'
                  }
                }
              );
              
              const data = await response.json();
              return data;
            } catch (error) {
              console.error('Error checking workflow status:', error);
              return null;
            }
          };

          const getArtifactUrl = async (runId, repo) => {
            try {
              const response = await fetch(
                `https://api.github.com/repos/${repo}/actions/runs/${runId}/artifacts`,
                {
                  headers: {
                    'Accept': 'application/vnd.github.v3+json'
                  }
                }
              );
              
              const data = await response.json();
              if (data.artifacts && data.artifacts.length > 0) {
                const artifactId = data.artifacts[0].id;
                return `https://github.com/${repo}/actions/runs/${runId}/artifacts/${artifactId}`;
              }
              return null;
            } catch (error) {
              console.error('Error getting artifact:', error);
              return null;
            }
          };

          const pollWorkflowStatus = async (runId, repo) => {
            const maxAttempts = 60;
            let attempts = 0;

            const poll = async () => {
              attempts++;
              const status = await checkWorkflowStatus(runId, repo);
              
              if (status) {
                setWorkflowStatus(status.status);
                
                if (status.status === 'completed') {
                  if (status.conclusion === 'success') {
                    const artifactUrl = await getArtifactUrl(runId, repo);
                    setDownloadUrl(artifactUrl);
                    setMessage({
                      type: 'success',
                      text: 'Labels erfolgreich generiert! PDF und CSV sind bereit zum Download.'
                    });
                    
                    await loadProductDatabase();
                    
                    const currentProduct = selectedProduct;
                    setSelectedProduct('');
                    setTimeout(() => setSelectedProduct(currentProduct), 100);
                  } else {
                    setMessage({
                      type: 'error',
                      text: 'Label-Generierung fehlgeschlagen. Bitte pr√ºfen Sie die Actions-Logs.'
                    });
                  }
                  setIsLoading(false);
                  return;
                }
                
                if (attempts < maxAttempts && status.status !== 'completed') {
                  setTimeout(poll, 5000);
                }
              }
            };

            poll();
          };

          const validateForm = () => {
            const newErrors = {};

            if (!selectedProduct) {
              newErrors.product = 'Bitte w√§hlen Sie ein Produkt aus';
            }

            if (!mfgDate) {
              newErrors.mfgDate = 'Herstellungsdatum erforderlich';
            } else if (!/^\d{6}$/.test(mfgDate)) {
              newErrors.mfgDate = 'Datum muss 6 Ziffern sein (JJMMTT)';
            }

            if (!serialNumber) {
              newErrors.serialNumber = 'Seriennummer erforderlich';
            } else if (parseInt(serialNumber) <= 0 || !Number.isInteger(Number(serialNumber))) {
              newErrors.serialNumber = 'Seriennummer muss eine positive Ganzzahl sein';
            }

            if (!labelCount) {
              newErrors.labelCount = 'Anzahl der Etiketten erforderlich';
            } else if (parseInt(labelCount) <= 0 || !Number.isInteger(Number(labelCount))) {
              newErrors.labelCount = 'Anzahl muss eine positive Ganzzahl sein';
            }

            setErrors(newErrors);
            return Object.keys(newErrors).length === 0;
          };

          const handleSubmit = async () => {
            if (!validateForm()) {
              return;
            }

            setIsLoading(true);
            setMessage(null);
            setWorkflowStatus('queued');
            setDownloadUrl(null);

            const product = products.find(p => p.id === selectedProduct);
            
            const payload = {
              product_data: product,
              gtin: product.gtin,
              mfg_date: mfgDate,
              serial_start: parseInt(serialNumber),
              count: parseInt(labelCount)
            };

            try {
              const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
              });

              const data = await response.json();

              if (data.success) {
                setMessage({
                  type: 'success',
                  text: `Job gestartet! Generiere ${labelCount} Etiketten f√ºr "${product.name_de}" (Serie ${serialNumber}-${parseInt(serialNumber) + parseInt(labelCount) - 1})...`
                });

                if (data.run_id) {
                  pollWorkflowStatus(data.run_id, data.repo);
                }

              } else {
                throw new Error(data.error || 'Workflow konnte nicht gestartet werden');
              }

            } catch (error) {
              setMessage({
                type: 'error',
                text: 'Fehler beim Starten des Jobs: ' + error.message
              });
              setIsLoading(false);
            }
          };

          const getStatusMessage = () => {
            if (!workflowStatus) return null;
            
            const statusMessages = {
              'queued': '‚è≥ In Warteschlange...',
              'in_progress': '‚öôÔ∏è Labels werden generiert...',
              'completed': '‚úÖ Fertig!'
            };
            
            return statusMessages[workflowStatus] || workflowStatus;
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
              <div className="max-w-2xl mx-auto">
                <div className="bg-white rounded-lg shadow-xl p-8">
                  <div className="mb-8 flex justify-between items-center">
                    <div>
                      <h1 className="text-3xl font-bold text-gray-800 mb-2">
                        UDI Etiketten Generator
                      </h1>
                      <p className="text-gray-600">
                        Medizinprodukt-Etiketten mit QR-Code erstellen
                      </p>
                    </div>
                    <button
                      onClick={handleRefresh}
                      className="px-4 py-2 text-sm bg-gray-200 hover:bg-gray-300 rounded-lg transition"
                    >
                      üîÑ Aktualisieren
                    </button>
                  </div>

                  <div className="space-y-6">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Produkt ausw√§hlen *
                      </label>
                      <select
                        value={selectedProduct}
                        onChange={(e) => setSelectedProduct(e.target.value)}
                        disabled={isLoading}
                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 ${
                          errors.product ? 'border-red-500' : 'border-gray-300'
                        }`}
                      >
                        <option value="">-- Bitte w√§hlen --</option>
                        {products.map(product => (
                          <option key={product.id} value={product.id}>
                            {product.name_de} ({product.group})
                          </option>
                        ))}
                      </select>
                      {errors.product && (
                        <p className="mt-1 text-sm text-red-600">{errors.product}</p>
                      )}
                      {selectedProduct && (
                        <div className="mt-2 p-3 bg-blue-50 rounded-lg text-sm text-gray-700">
                          <p><strong>GTIN:</strong> {products.find(p => p.id === selectedProduct)?.gtin}</p>
                          <p><strong>Beschreibung:</strong> {products.find(p => p.id === selectedProduct)?.description_de}</p>
                        </div>
                      )}
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Herstellungsdatum (JJMMTT) *
                      </label>
                      <input
                        type="text"
                        value={mfgDate}
                        onChange={(e) => setMfgDate(e.target.value.replace(/\D/g, '').slice(0, 6))}
                        disabled={isLoading}
                        placeholder="250122"
                        maxLength="6"
                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 ${
                          errors.mfgDate ? 'border-red-500' : 'border-gray-300'
                        }`}
                      />
                      {errors.mfgDate && (
                        <p className="mt-1 text-sm text-red-600">{errors.mfgDate}</p>
                      )}
                      <p className="mt-1 text-xs text-gray-500">
                        Beispiel: 22. Januar 2025 = 250122
                      </p>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Start-Seriennummer *
                      </label>
                      <input
                        type="number"
                        value={serialNumber}
                        onChange={(e) => setSerialNumber(e.target.value)}
                        disabled={isLoading}
                        placeholder="8110007001"
                        min="1"
                        step="1"
                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 ${
                          errors.serialNumber ? 'border-red-500' : 'border-gray-300'
                        }`}
                      />
                      {errors.serialNumber && (
                        <p className="mt-1 text-sm text-red-600">{errors.serialNumber}</p>
                      )}
                      {selectedProduct && (
                        <p className="mt-1 text-xs text-gray-500">
                          Letzte verwendete Nummer: {products.find(p => p.id === selectedProduct)?.lastSerial}
                        </p>
                      )}
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Anzahl der Etiketten *
                      </label>
                      <input
                        type="number"
                        value={labelCount}
                        onChange={(e) => setLabelCount(e.target.value)}
                        disabled={isLoading}
                        placeholder="1"
                        min="1"
                        step="1"
                        className={`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100 ${
                          errors.labelCount ? 'border-red-500' : 'border-gray-300'
                        }`}
                      />
                      {errors.labelCount && (
                        <p className="mt-1 text-sm text-red-600">{errors.labelCount}</p>
                      )}
                    </div>

                    <button
                      onClick={handleSubmit}
                      disabled={isLoading}
                      className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"
                    >
                      {isLoading ? getStatusMessage() || 'Job wird gestartet...' : 'UDI Job erzeugen'}
                    </button>
                  </div>

                  {message && (
                    <div className={`mt-6 p-4 rounded-lg ${
                      message.type === 'success' ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'
                    }`}>
                      <p className="font-medium">{message.text}</p>
                      {message.type === 'success' && workflowStatus && (
                        <div className="mt-2">
                          <p className="text-sm">{getStatusMessage()}</p>
                          {downloadUrl ? (
                            <a 
                              href={downloadUrl}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="mt-2 inline-block text-sm bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                            >
                              üì• PDF & CSV herunterladen
                            </a>
                          ) : isLoading && (
                            <p className="mt-2 text-sm text-gray-600">
                              Bitte warten, w√§hrend die Dateien generiert werden...
                            </p>
                          )}
                        </div>
                      )}
                    </div>
                  )}

                  <div className="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 className="font-semibold text-gray-800 mb-2">‚ÑπÔ∏è Hinweise</h3>
                    <ul className="text-sm text-gray-600 space-y-1">
                      <li>‚Ä¢ Alle Felder mit * sind Pflichtfelder</li>
                      <li>‚Ä¢ Die Seriennummer wird automatisch aktualisiert</li>
                      <li>‚Ä¢ PDF und CSV werden gleichzeitig generiert</li>
                      <li>‚Ä¢ Download-Link erscheint nach ~30-60 Sekunden</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          );
        };
        
        ReactDOM.render(<UDILabelGenerator />, document.getElementById('root'));
    </script>
</body>
</html>
